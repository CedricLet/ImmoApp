# ImmoApp

Gestion immobili√®re (biens, documents, co√ªts, comptes) avec import de PDF enrichi par IA.

## ‚öôÔ∏è Pr√©requis & configuration (√† faire **avant** de lancer Spring)

### 1) Cr√©er la base de donn√©es

* Cr√©e **une base vide** nomm√©e `ImmoApp` dans MySQL/MariaDB.
* **N‚Äôajoute aucune table** (Flyway s‚Äôen charge).
* Encodage conseill√© : `utf8mb4` et collation `utf8mb4_unicode_ci`.

```sql
CREATE DATABASE ImmoApp
  CHARACTER SET utf8mb4
  COLLATE utf8mb4_unicode_ci;
```

### 2) C‚Äôest quoi Flyway ?

[Flyway](https://flywaydb.org/) est un outil de **migration de sch√©ma**.
Il ex√©cute automatiquement les scripts SQL dans `src/main/resources/db/migration` pour **cr√©er/mettre √† jour** les tables au d√©marrage de l‚Äôapplication, dans le bon ordre et de fa√ßon versionn√©e.

> ‚ö†Ô∏è **Ne lance pas Spring** tant que la configuration ci-dessous n‚Äôest pas faite, sinon Flyway √©chouera √† se connecter et ne pourra pas cr√©er le sch√©ma.

### 3) Configurer l‚Äôacc√®s √† la DB et les secrets

Le projet charge `application.properties` (et **optionnellement** `src/main/resources/env.properties` si pr√©sent) :

```
spring.config.import=optional:file:src/main/resources/env.properties
```

Tu peux soit :

* **tout mettre dans `application.properties`**,
* soit cr√©er `src/main/resources/env.properties` pour y mettre tes valeurs locales (recommand√© pour ne pas committer tes secrets).

Exemple minimal (√† adapter) :

```properties
# --- Database ---
spring.datasource.url=jdbc:mysql://localhost:3306/ImmoApp?useUnicode=true&characterEncoding=utf8&connectionTimeZone=UTC
spring.datasource.username=ton_user
spring.datasource.password=ton_password
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

# --- JWT ---
# **Obligatoire** : secret HMAC long et al√©atoire
app.jwt.secret=change_me_with_a_random_32_bytes_min_secret
app.jwt.exp-minutes=10080

# --- OpenAI (d√©j√† pr√©sent dans le projet) ---
spring.ai.openai.api-key=ta_clef_ou_la_variable_env
spring.ai.openai.chat.options.model=gpt-5-nano
```

#### Choisir un bon secret JWT

* Utilise **au minimum 32 octets (256 bits)** d‚Äôentropie (recommand√© : 64 octets).
* Exemples pour g√©n√©rer un secret :

  * macOS/Linux : `openssl rand -base64 32`
  * Node.js : `node -e "console.log(require('crypto').randomBytes(32).toString('base64'))"`

> Plus le secret est long et al√©atoire, mieux c‚Äôest. √âvite les mots de passe ‚Äúlisibles‚Äù.

### 4) Comptes de test

Deux utilisateurs sont d√©j√† pr√©sents :

* **[admin@immoapp.local](mailto:admin@immoapp.local)** ‚Üí `admin123`
* **[owner@immoapp.local](mailto:owner@immoapp.local)** ‚Üí `owner123`

> Tu peux te connecter avec ces comptes pour tester l‚Äôapp de bout en bout.

---

## ‚ñ∂Ô∏è Lancer l‚Äôapplication

### Backend (Spring Boot)

* Java 17+ recommand√©.
* Depuis l‚ÄôIDE ou en CLI :

  * `./mvnw spring-boot:run` ou ex√©cuter la classe `ImmoAppApplication`.
* Au premier d√©marrage, **Flyway** cr√©e/√©volue le sch√©ma dans la DB `ImmoApp`.

### Frontend (Angular)

* Node 18+ recommand√©.
* `cd frontend` (si ton code Angular est dans un dossier d√©di√©)
* `npm install`
* `npm start` ou `ng serve`
* Ouvre [http://localhost:4200](http://localhost:4200)

---

## üß≠ Ce que l‚Äôapplication permet de faire

* **Authentification & r√¥les**
  Connexion/inscription.

* **Profil & s√©curit√©**
  Modifier le profil, changer le mot de passe, d√©connexion.

* **Biens immobiliers**
  Cr√©er/√©diter/supprimer des biens, voir leur statut (lou√©, en travaux, etc.).
  Ajouter un locataire au bien. Le bien doit √™tre FOR_RENT pour pouvoir ajouter le locataire.

* **Documents**

  * **Upload PDF** (drag & drop, s√©lection ou collage depuis le presse-papier).
  * **Analyse IA automatique** du PDF **√† l‚Äôimport** :

    * proposition de **cat√©gorie** (ex. Facture, Contrat‚Ä¶),
    * **type d‚Äô√©nergie** √©ventuel (√©lectricit√©, gaz‚Ä¶),
    * **tags** pertinents,
    * **nom de fichier sugg√©r√©** (kebab-case `.pdf`).
  * Filtres par **cat√©gorie**, **√©nergie**, **tags**, **recherche texte**, **bien**.
  * **Arborescence** (√ânergie ‚Üí √âlectricit√©/Gaz/Eau‚Ä¶) c√¥t√© gauche.
  * **√âdition** des m√©tadonn√©es (cat√©gorie/√©nergie/tags/nom de fichier).
  * **Suppression** d‚Äôun document.
  * Les PDF sont stock√©s c√¥t√© serveur (dossiers `uploads/tmp` puis `uploads/docs`), avec une **limite de taille configurable**.

* **Co√ªts / Factures**

  * Ajouter, lister, rechercher et **modifier** des co√ªts (revenus/d√©penses).
  * Cat√©gories (√©lectricit√©, gaz, taxes, loyer, travaux, etc.) et **types** (d√©pense / revenu).
  * **Comptabilit√©** synth√©tique : total revenus, total d√©penses, solde.
  * Pagination, recherche, notes.

* **Internationalisation (labels)**
  Les enums principaux sont traduits c√¥t√© UI (ex. cat√©gories, √©nergies, r√¥les‚Ä¶).

* **Horodatage & fuseau horaire**

  * Stockage en **UTC** c√¥t√© serveur, conversion √† l‚Äôaffichage en **Europe/Brussels**.
  * √âvite les d√©calages (heure d‚Äô√©t√©/hiver).

---

## üìÅ R√©pertoires d‚Äôupload (backend)

* `uploads/tmp` : zone **temporaire** pour les fichiers en ‚Äústage‚Äù (pr√©-analyse IA).

  * Nettoyage p√©riodique configurable (TTL).
* `uploads/docs` : zone **finale** apr√®s ‚Äúfinalize‚Äù.

Les limites de taille sont configurables dans `application.properties` :

```properties
app.upload.max-mb=25
spring.servlet.multipart.max-file-size=25MB
spring.servlet.multipart.max-request-size=30MB
```

---

## ‚ùóÔ∏èD√©pannage rapide

* **Spring d√©marre mais aucune table n‚Äôappara√Æt** ‚Üí V√©rifie l‚ÄôURL/identifiants DB, que la base `ImmoApp` existe, et les logs Flyway.
* **Erreurs de fuseau horaire MySQL** ‚Üí Ajoute `connectionTimeZone=UTC` dans l‚ÄôURL JDBC (ou `serverTimezone=UTC` selon le driver).
* **JWT invalide** ‚Üí Secret trop court ou variable manquante.
* **Upload refus√©** ‚Üí PDF requis + taille ‚â§ `app.upload.max-mb`.

---

## üîí S√©curit√© & bonnes pratiques

* Ne commite **jamais** tes secrets r√©els (`app.jwt.secret`, cl√©s API).
* Utilise `env.properties` local pour les valeurs sensibles.
* Garde les d√©pendances √† jour.

---